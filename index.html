<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein-Protein Interaction Search</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #searchInput {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        #searchInput:focus {
            outline: none;
            border-color: #667eea;
        }

        #searchButton {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
        }

        #searchButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #searchButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            padding: 30px;
        }

        .result-count {
            margin-bottom: 20px;
            padding: 15px;
            background: #e8eaf6;
            border-radius: 8px;
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }

        .uniprot-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
        }

        .uniprot-link:hover {
            background-color: #e8eaf6;
            text-decoration: underline;
            transform: translateY(-1px);
        }

        .external-icon {
            font-size: 0.8em;
            margin-left: 3px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 18px;
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .success-message {
            background-color: #efe;
            color: #2d7a2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .info-message {
            background-color: #e8eaf6;
            color: #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .gene-info {
            background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .gene-info strong {
            color: #667eea;
        }

        .gene-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .gene-info-label {
            font-weight: 600;
            color: #667eea;
        }

        .highlight-cell {
            background-color: #fff3cd !important;
            font-weight: 600;
        }

        .score-high {
            color: #2d7a2d;
            font-weight: 600;
        }

        .score-medium {
            color: #f57c00;
            font-weight: 600;
        }

        .score-low {
            color: #c33;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Protein-Protein Interaction Search</h1>
            <p>Discover protein interactions with confidence scores</p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Enter gene name (e.g., TP53, BRCA1) or UniProt ID (e.g., P04637)"
                    autocomplete="off"
                />
                <button id="searchButton">üîç Search</button>
            </div>
            <div class="info-text">
                üí° <strong>How it works:</strong> Enter a gene name or UniProt ID. The tool will automatically:
                <br>‚Ä¢ Convert gene names to UniProt IDs using the UniProt database
                <br>‚Ä¢ Find all protein-protein interactions involving your protein
                <br>‚Ä¢ Display interaction confidence scores and detailed information
                <br>‚Ä¢ Provide direct links to UniProt for all proteins
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display:none;">
            <div id="messageBox"></div>
            <div id="geneInfo"></div>
            <div id="resultCount" class="result-count"></div>
            <div class="table-container" id="resultsTable"></div>
        </div>
    </div>

    <script>
        let proteinData = [];
        
        // Load the TSV file
        async function loadData() {
            try {
                const response = await fetch('candidate_predictions_combined.tsv');
                const text = await response.text();
                const lines = text.split('\n');
                
                // Filter out comment lines (starting with #) and empty lines
                const dataLines = lines.filter(line => {
                    const trimmed = line.trim();
                    return trimmed && !trimmed.startsWith('#');
                });
                
                // Parse TSV - keep exact column names as they are
                const headers = dataLines[0].split('\t').map(h => h.trim());
                proteinData = dataLines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = line.split('\t');
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = values[index]?.trim() || '';
                        });
                        return obj;
                    });
                
                console.log('‚úÖ Data loaded successfully!');
                console.log('üìä Total interactions:', proteinData.length);
                console.log('üìã Columns:', headers);
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showMessage('Error loading data file. Please ensure candidate_predictions_combined.tsv is in the same directory.', 'error');
            }
        }

        // Convert gene name to UniProt ID using UniProt API
        async function geneToUniProt(geneName) {
            try {
                const url = `https://rest.uniprot.org/uniprotkb/search?query=gene:${geneName}+AND+organism_id:9606&format=json&size=5`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('UniProt API request failed');
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    return {
                        uniprotId: result.primaryAccession,
                        geneName: result.genes?.[0]?.geneName?.value || geneName,
                        proteinName: result.proteinDescription?.recommendedName?.fullName?.value || 'Unknown protein',
                        organism: 'Homo sapiens (Human)',
                        found: true
                    };
                }
                
                return { found: false };
            } catch (error) {
                console.error('Error fetching from UniProt:', error);
                return { found: false, error: error.message };
            }
        }

        // Check if input is already a UniProt ID
        function isUniProtID(input) {
            const uniprotPattern = /^[OPQ][0-9][A-Z0-9]{3}[0-9]$|^[A-NR-Z][0-9]([A-Z][A-Z0-9]{2}[0-9]){1,2}$/;
            return uniprotPattern.test(input.toUpperCase());
        }

        // Check if a string looks like a UniProt ID
        function looksLikeUniProtID(str) {
            if (!str || str.length < 6 || str.length > 10) return false;
            return /^[A-Z][0-9][A-Z0-9]{3,8}$/.test(str.toUpperCase());
        }

        // Create UniProt link
        function createUniProtLink(uniprotId, highlight = false) {
            if (!uniprotId || !looksLikeUniProtID(uniprotId)) return uniprotId || 'N/A';
            const className = highlight ? 'uniprot-link highlight-cell' : 'uniprot-link';
            return `<a href="https://www.uniprot.org/uniprotkb/${uniprotId}" target="_blank" class="${className}">${uniprotId}<span class="external-icon">‚Üó</span></a>`;
        }

        // Format score with color coding
        function formatScore(score) {
            if (!score || score === '') return 'N/A';
            const numScore = parseFloat(score);
            if (isNaN(numScore)) return score;
            
            let className = 'score-low';
            if (numScore >= 0.7) className = 'score-high';
            else if (numScore >= 0.4) className = 'score-medium';
            
            return `<span class="${className}">${numScore.toFixed(4)}</span>`;
        }

        // Search function
        async function searchProtein() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                showMessage('Please enter a gene name or UniProt ID', 'error');
                return;
            }

            if (proteinData.length === 0) {
                showMessage('Data not loaded yet. Please wait a moment and try again.', 'error');
                return;
            }

            const searchButton = document.getElementById('searchButton');
            searchButton.disabled = true;
            searchButton.textContent = 'üîç Searching...';

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsTable').innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching for interactions...</p></div>';
            document.getElementById('messageBox').innerHTML = '';
            document.getElementById('geneInfo').innerHTML = '';

            let searchUniProtId = searchTerm.toUpperCase();
            let geneInfo = null;

            // If not a UniProt ID, try to convert gene name to UniProt ID
            if (!isUniProtID(searchTerm)) {
                showMessage(`üîç Looking up UniProt ID for gene: <strong>${searchTerm}</strong>`, 'info');
                geneInfo = await geneToUniProt(searchTerm);
                
                if (geneInfo.found) {
                    searchUniProtId = geneInfo.uniprotId;
                    
                    document.getElementById('geneInfo').innerHTML = `
                        <div class="gene-info">
                            <div style="font-size: 18px; margin-bottom: 15px;">
                                <strong>‚úÖ Gene Found!</strong>
                            </div>
                            <div class="gene-info-grid">
                                <span class="gene-info-label">Gene Name:</span>
                                <span>${geneInfo.geneName}</span>
                                
                                <span class="gene-info-label">UniProt ID:</span>
                                <span><a href="https://www.uniprot.org/uniprotkb/${geneInfo.uniprotId}" target="_blank" class="uniprot-link">${geneInfo.uniprotId}<span class="external-icon">‚Üó</span></a></span>
                                
                                <span class="gene-info-label">Protein Name:</span>
                                <span>${geneInfo.proteinName}</span>
                                
                                <span class="gene-info-label">Organism:</span>
                                <span>${geneInfo.organism}</span>
                            </div>
                        </div>
                    `;
                    showMessage(`‚úÖ Successfully mapped gene "${searchTerm}" to UniProt ID: ${geneInfo.uniprotId}`, 'success');
                } else {
                    showMessage(`‚ö†Ô∏è Could not find UniProt ID for gene "${searchTerm}". Searching with original term...`, 'error');
                }
            } else {
                showMessage(`üîç Searching for UniProt ID: <strong>${searchUniProtId}</strong>`, 'info');
            }

            // Search in the data - find all interactions where the protein appears in EITHER Protein1 OR Protein2
            const results = proteinData.filter(row => {
                const protein1 = (row.Protein1 || '').toUpperCase();
                const protein2 = (row.Protein2 || '').toUpperCase();
                
                // Match exact UniProt ID in either column
                return protein1 === searchUniProtId || protein2 === searchUniProtId;
            });

            console.log('üîç Searching for UniProt ID:', searchUniProtId);
            console.log('üìä Total interactions found:', results.length);
            
            displayResults(results, searchUniProtId);

            searchButton.disabled = false;
            searchButton.textContent = 'üîç Search';
        }

        // Display results
        function displayResults(results, searchUniProtId) {
            const resultCount = document.getElementById('resultCount');
            const resultsTable = document.getElementById('resultsTable');

            if (results.length === 0) {
                resultsTable.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üî¨</div>
                        <strong>No interactions found for UniProt ID: ${searchUniProtId}</strong>
                        <p style="margin-top: 10px; color: #666;">
                            This protein may not have any predicted interactions in the database,<br>
                            or the ID might not be present in the dataset.
                        </p>
                    </div>
                `;
                resultCount.textContent = '';
                return;
            }

            resultCount.innerHTML = `
                üéØ Found <strong>${results.length}</strong> interaction${results.length > 1 ? 's' : ''} 
                for UniProt ID: <strong>${searchUniProtId}</strong>
            `;

            // Get column headers from first result - USE EXACT NAMES FROM TSV
            const headers = Object.keys(results[0]);

            // Create table with exact column names
            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
                // Keep the exact column name as it is in the TSV file
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            // Add rows
            results.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    let value = row[header];
                    const isSearchedProtein1 = header === 'Protein1' && value.toUpperCase() === searchUniProtId;
                    const isSearchedProtein2 = header === 'Protein2' && value.toUpperCase() === searchUniProtId;
                    
                    // Format protein columns with links and highlighting
                    if (header === 'Protein1' || header === 'Protein2') {
                        const isHighlight = isSearchedProtein1 || isSearchedProtein2;
                        const cellClass = isHighlight ? ' class="highlight-cell"' : '';
                        value = createUniProtLink(value, isHighlight);
                        tableHTML += `<td${cellClass}>${value}</td>`;
                    }
                    // Format score columns
                    else if (header.toLowerCase().includes('prob') || header.toLowerCase().includes('score')) {
                        value = formatScore(value);
                        tableHTML += `<td>${value}</td>`;
                    }
                    // Regular columns
                    else {
                        tableHTML += `<td>${value}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            resultsTable.innerHTML = tableHTML;
        }

        // Show message
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            let className = 'info-message';
            if (type === 'error') className = 'error-message';
            else if (type === 'success') className = 'success-message';
            
            messageBox.innerHTML = `<div class="${className}">${message}</div>`;
        }

        // Event listeners
        document.getElementById('searchButton').addEventListener('click', searchProtein);
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchProtein();
            }
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
